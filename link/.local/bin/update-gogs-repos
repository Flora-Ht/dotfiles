#!/bin/bash

# Get .bashrc path
if [ -e ~/.mybashrc ]
then
	BASHRC_PATH=~/.mybashrc
else
	BASHRC_PATH=~/.bashrc
fi

# Trying to download 'colorsrc'
if [ ! -e ~/.local/lib/colorsrc ]
then
	curl -O http://git.gnidmoo.tk/gnidmoo/dotfiles/raw/master/link/.local/lib/colorsrc > /dev/null 2>&1 && \
	mkdir -p ~/.local/lib && \
	mv colorsrc ~/.local/lib/
fi

if [ -e ~/.local/lib/colorsrc ]
then
	source ~/.local/lib/colorsrc
fi

# Get username for Gogs
if [ -z "$GOGS_USER" ]
then
	echo -ne "${BCYAN}Please enter your Gogs username:" $WHITE
	read gogs_username
	echo -e "\nexport GOGS_USER=$gogs_username\n" >> $BASHRC_PATH
	export GOGS_USER=$gogs_username
	echo
fi

echo -e "${BGREEN}\\o/ Welcome" $GOGS_USER "\\o/\n"

# Add gogs to repositories
for i in $(find . -maxdepth 1 -type d -print | sed 's/^\.\///')
do
	if [ "$i" != "." ]
	then
		cd "$(pwd)/$i"
		if [ -d .git ] && [ -n "$(git remote -v | grep epitech)" ]
		then
			if [ -n "$(git remote -v | grep gogs)" ]
			then
				echo -e "$BBLUE$(pwd) already has a rule for Gogs" $WHITE "\n"
				cd ..
				continue
			fi
			
			echo -e "$BCYAN=> Trying to add 'gogs' remote in $(basename "$(pwd)")..." $WHITE
			git remote remove origin
			git remote add origin git@git.epitech.eu:/${USER}/$(basename "$(pwd)")
			git remote set-url --add --push origin git@git.epitech.eu:/${USER}/$(basename "$(pwd)")
			
			# Add 'gogs' remote to gogs repos
			gogs_repo="$(basename "$(pwd)" | tr '[:upper:]' '[:lower:]').git"
			push="$(git push gogs@git.gnidmoo.tk:$GOGS_USER/$gogs_repo master 2>&1)"
			if [ -z "$(echo "$push" "=>" "$?" | grep Gogs)" ]
			then
				echo -e $BBLUE "[*] Gogs repo found in" "$(pwd)" $WHITE
				git remote set-url --add --push origin gogs@git.gnidmoo.tk:$GOGS_USER/$(echo $(basename "$(pwd)") | tr '[:upper:]' '[:lower:]').git
				
				echo -e $BBLUE "[*] Trying to push to 'origin'..." $WHITE
				push_code="$(git push -u origin master > /dev/null 2>&1 ; echo $?)"
				if [ "$push_code" == "0" ]
				then
					echo -e $BGREEN "[*] OK." $WHITE
				else
					echo -e $BRED "[*] Failed. Code: $push_code" $WHITE
				fi
			else
				echo -e $BBLUE "[*] $(pwd) is not a Gogs repo" $WHITE
			fi
		else
			echo -e "$BBLUE$(pwd) is not an Epitech repo" $WHITE
		fi
		echo
		cd ..
	fi
done
